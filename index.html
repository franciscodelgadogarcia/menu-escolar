<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MenÃº Escolar - Comunidad de Madrid</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f8f9fa; }
    h1 { color: #2c3e50; text-align: center; }
    .container { max-width: 1600px; margin: 0 auto; }
    .controls { background: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; }
    table { width: 100%; border-collapse: collapse; background: white; margin-top: 20px; }
    th, td { padding: 10px; text-align: center; border: 1px solid #dee2e6; font-size: 0.9em; }
    th { background: #e9ecef; }
    select, input { padding: 5px; margin: 0 5px; font-size: 0.95em; }
    button { background: #198754; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; margin: 4px; font-size: 0.95em; }
    button:hover { background: #157347; }
    .day-cell { min-width: 120px; }
    .save-section { text-align: center; margin-top: 20px; }
    @media (max-width: 768px) {
      .day-cell { min-width: 100px; font-size: 0.85em; }
      select, input { font-size: 0.85em; }
      th, td { padding: 6px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ðŸ“… Generador de MenÃºs Escolares - Comunidad de Madrid</h1>

    <div class="controls">
      <label for="mes">Mes:</label>
      <select id="mes">
        <option value="0">Enero</option>
        <option value="1">Febrero</option>
        <option value="2">Marzo</option>
        <option value="3">Abril</option>
        <option value="4">Mayo</option>
        <option value="5">Junio</option>
        <option value="6">Julio</option>
        <option value="7">Agosto</option>
        <option value="8">Septiembre</option>
        <option value="9">Octubre</option>
        <option value="10">Noviembre</option>
        <option value="11">Diciembre</option>
      </select>

      <label for="anio">AÃ±o:</label>
      <input type="number" id="anio" value="2024" min="2020" max="2030">

      <label for="colegio">Colegio:</label>
      <select id="colegio">
        <option value="CEIP JOSÃ‰ HIERRO">CEIP JOSÃ‰ HIERRO</option>
        <option value="CEIP CALVO SOTELO">CEIP CALVO SOTELO</option>
        <option value="HANS CHRISTIAN ANDERSEN">HANS CHRISTIAN ANDERSEN</option>
        <option value="CEIP SAN ISIDORA">CEIP SAN ISIDORA</option>
        <option value="CEIP LA LUNA">CEIP LA LUNA</option>
        <option value="CEIP VICTORIA KENT">CEIP VICTORIA KENT</option>
        <option value="NUESTRA SEÃ‘ORA DE LA ALMUDENA">NUESTRA SEÃ‘ORA DE LA ALMUDENA</option>
        <option value="CEIP PADRE MARIANA">CEIP PADRE MARIANA</option>
        <option value="ANGEL BERZAL">ANGEL BERZAL</option>
        <option value="ANTONIO MACHADO">ANTONIO MACHADO</option>
        <option value="CARMEN CONDE">CARMEN CONDE</option>
        <option value="CEE MARIA ISABEL ZULUETA">CEE MARIA ISABEL ZULUETA</option>
        <option value="CHAVES NOGALES">CHAVES NOGALES</option>
        <option value="CLARA CAMPOAMOR">CLARA CAMPOAMOR</option>
        <option value="CPEE VALLECAS">CPEE VALLECAS</option>
        <option value="GARCIA MORENTE">GARCIA MORENTE</option>
        <option value="HENARES">HENARES</option>
        <option value="MESONEROS ROMANOS">MESONEROS ROMANOS</option>
        <option value="VIRGEN DE LA RIBERA">VIRGEN DE LA RIBERA</option>
        <option value="VIRGEN DEL CORTIJO">VIRGEN DEL CORTIJO</option>
      </select>

      <button onclick="generarCalendario()">Generar calendario</button>
    </div>

    <div id="calendario"></div>

    <div class="save-section">
      <button onclick="guardarMenu()">ðŸ’¾ Guardar menÃº</button>
      <button onclick="exportarPorColegio()">ðŸ“¥ Exportar menÃº para este colegio</button>
    </div>
  </div>

  <script>
    let platos = [];
    let menuMensual = {};

    fetch('/api/platos')
      .then(res => res.json())
      .then(data => {
        platos = data.platos;
        const anioActual = new Date().getFullYear();
        document.getElementById('anio').value = anioActual;
        generarCalendario();
      });

    function clasificarPlatos() {
      const primeros = platos.filter(p => p.archivo.startsWith("PR."));
      const segundos = platos.filter(p => p.archivo.startsWith("PO."));
      const acompanamientos = platos.filter(p => p.archivo.startsWith("AC."));
      const postres = platos.filter(p => p.archivo.startsWith("DE."));
      const panes = platos.filter(p => p.archivo.startsWith("PA."));
      
      return { primeros, segundos, acompanamientos, postres, panes };
    }

    function generarCalendario() {
      const mes = parseInt(document.getElementById('mes').value);
      const anio = parseInt(document.getElementById('anio').value);
      const clave = `menu_${anio}_${mes}`;

      const guardado = localStorage.getItem(clave);
      if (guardado) {
        try {
          menuMensual = JSON.parse(guardado);
        } catch (e) {
          menuMensual = {};
        }
      } else {
        menuMensual = {};
      }

      const { primeros, segundos, acompanamientos, postres, panes } = clasificarPlatos();
      let html = `<table><thead><tr>
        <th>DÃ­a</th>
        <th>1Âº Plato</th>
        <th>2Âº Plato</th>
        <th>AcompaÃ±amiento</th>
        <th>Postre</th>
        <th>Pan</th>
      </tr></thead><tbody>`;

      const primerDia = new Date(anio, mes, 1);
      const ultimoDia = new Date(anio, mes + 1, 0);

      for (let d = primerDia.getDate(); d <= ultimoDia.getDate(); d++) {
        const fecha = new Date(anio, mes, d);
        const diaSemana = fecha.getDay();
        if (diaSemana >= 1 && diaSemana <= 5) {
          const fechaStr = fecha.toISOString().split('T')[0];
          const menuDia = menuMensual[fechaStr] || { primer: "", segundo: "", acompanamiento: "", postre: "", pan: "" };

          html += `
            <tr>
              <td class="day-cell">${d} (${['', 'Lun', 'Mar', 'MiÃ©', 'Jue', 'Vie'][diaSemana]})</td>
              <td>
                <select onchange="actualizarMenu('${fechaStr}', 'primer', this.value)">
                  <option value="">-- Seleccionar --</option>
                  ${primeros.map(p => `<option value="${p.nombre}" ${p.nombre === menuDia.primer ? 'selected' : ''}>${p.nombre}</option>`).join('')}
                </select>
              </td>
              <td>
                <select onchange="actualizarMenu('${fechaStr}', 'segundo', this.value)">
                  <option value="">-- Seleccionar --</option>
                  ${segundos.map(p => `<option value="${p.nombre}" ${p.nombre === menuDia.segundo ? 'selected' : ''}>${p.nombre}</option>`).join('')}
                </select>
              </td>
              <td>
                <select onchange="actualizarMenu('${fechaStr}', 'acompanamiento', this.value)">
                  <option value="">-- Opcional --</option>
                  ${acompanamientos.map(p => `<option value="${p.nombre}" ${p.nombre === menuDia.acompanamiento ? 'selected' : ''}>${p.nombre}</option>`).join('')}
                </select>
              </td>
              <td>
                <select onchange="actualizarMenu('${fechaStr}', 'postre', this.value)">
                  <option value="">-- Seleccionar --</option>
                  ${postres.map(p => `<option value="${p.nombre}" ${p.nombre === menuDia.postre ? 'selected' : ''}>${p.nombre}</option>`).join('')}
                </select>
              </td>
              <td>
                <select onchange="actualizarMenu('${fechaStr}', 'pan', this.value)">
                  <option value="">-- Seleccionar --</option>
                  ${panes.map(p => `<option value="${p.nombre}" ${p.nombre === menuDia.pan ? 'selected' : ''}>${p.nombre}</option>`).join('')}
                </select>
              </td>
            </tr>`;
        }
      }

      html += `</tbody></table>`;
      document.getElementById('calendario').innerHTML = html;
    }

    function actualizarMenu(fecha, tipo, valor) {
      if (!menuMensual[fecha]) menuMensual[fecha] = { primer: "", segundo: "", acompanamiento: "", postre: "", pan: "" };
      menuMensual[fecha][tipo] = valor;
    }

    function guardarMenu() {
      const mes = document.getElementById('mes').value;
      const anio = document.getElementById('anio').value;
      const clave = `menu_${anio}_${mes}`;
      localStorage.setItem(clave, JSON.stringify(menuMensual));
      alert(`âœ… MenÃº de ${anio}-${String(parseInt(mes)+1).padStart(2,'0')} guardado.`);
    }

    function exportarPorColegio() {
      const colegio = document.getElementById('colegio').value;
      if (!colegio) {
        alert("Por favor, selecciona un colegio.");
        return;
      }

      const mesIndex = document.getElementById('mes').value;
      const anio = document.getElementById('anio').value;
      const nombreMes = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"][mesIndex];

      fetch('/api/exportar', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          colegio,
          mes: nombreMes,
          anio,
          menu: menuMensual
        })
      })
      .then(response => {
        if (!response.ok) {
          return response.json().then(err => { throw new Error(err.error || 'Error desconocido'); });
        }
        return response.blob();
      })
      .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `menu_escolar_${colegio.replace(/\s+/g, '_')}_${nombreMes}_${anio}.xlsx`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error al generar el Excel: ' + error.message);
      });
    }
  </script>
</body>
</html>
