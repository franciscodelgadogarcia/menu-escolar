<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MenÃº Escolar - Comunidad de Madrid</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f8f9fa; }
    h1 { color: #2c3e50; text-align: center; }
    .container { max-width: 1600px; margin: 0 auto; }
    .controls { background: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; }
    table { width: 100%; border-collapse: collapse; background: white; margin-top: 20px; }
    th, td { padding: 10px; text-align: center; border: 1px solid #dee2e6; font-size: 0.9em; }
    th { background: #e9ecef; }
    select, input { padding: 5px; margin: 0 5px; font-size: 0.95em; }
    button { background: #198754; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; margin: 4px; font-size: 0.95em; }
    button:hover { background: #157347; }
    .day-cell { min-width: 120px; }
    .save-section { text-align: center; margin-top: 20px; }
    @media (max-width: 768px) {
      .day-cell { min-width: 100px; font-size: 0.85em; }
      select, input { font-size: 0.85em; }
      th, td { padding: 6px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ðŸ“… Generador de MenÃºs Escolares - Comunidad de Madrid</h1>

    <div class="controls">
      <label for="mes">Mes:</label>
      <select id="mes">
        <option value="0">Enero</option>
        <option value="1">Febrero</option>
        <option value="2">Marzo</option>
        <option value="3">Abril</option>
        <option value="4">Mayo</option>
        <option value="5">Junio</option>
        <option value="6">Julio</option>
        <option value="7">Agosto</option>
        <option value="8">Septiembre</option>
        <option value="9">Octubre</option>
        <option value="10">Noviembre</option>
        <option value="11">Diciembre</option>
      </select>

      <label for="anio">AÃ±o:</label>
      <input type="number" id="anio" value="2024" min="2020" max="2030">

      <label for="colegio">Colegio:</label>
      <select id="colegio">
        <option value="CEIP JOSÃ‰ HIERRO">CEIP JOSÃ‰ HIERRO</option>
        <option value="CEIP CALVO SOTELO">CEIP CALVO SOTELO</option>
        <option value="HANS CHRISTIAN ANDERSEN">HANS CHRISTIAN ANDERSEN</option>
        <option value="CEIP SAN ISIDORA">CEIP SAN ISIDORA</option>
        <option value="CEIP LA LUNA">CEIP LA LUNA</option>
        <option value="CEIP VICTORIA KENT">CEIP VICTORIA KENT</option>
        <option value="NUESTRA SEÃ‘ORA DE LA ALMUDENA">NUESTRA SEÃ‘ORA DE LA ALMUDENA</option>
        <option value="CEIP PADRE MARIANA">CEIP PADRE MARIANA</option>
        <option value="ANGEL BERZAL">ANGEL BERZAL</option>
        <option value="ANTONIO MACHADO">ANTONIO MACHADO</option>
        <option value="CARMEN CONDE">CARMEN CONDE</option>
        <option value="CEE MARIA ISABEL ZULUETA">CEE MARIA ISABEL ZULUETA</option>
        <option value="CHAVES NOGALES">CHAVES NOGALES</option>
        <option value="CLARA CAMPOAMOR">CLARA CAMPOAMOR</option>
        <option value="CPEE VALLECAS">CPEE VALLECAS</option>
        <option value="GARCIA MORENTE">GARCIA MORENTE</option>
        <option value="HENARES">HENARES</option>
        <option value="MESONEROS ROMANOS">MESONEROS ROMANOS</option>
        <option value="VIRGEN DE LA RIBERA">VIRGEN DE LA RIBERA</option>
        <option value="VIRGEN DEL CORTIJO">VIRGEN DEL CORTIJO</option>
      </select>

      <button onclick="generarCalendario()">Generar calendario</button>
    </div>

    <div id="calendario"></div>

    <div class="save-section">
      <button onclick="guardarMenu()">ðŸ’¾ Guardar menÃº</button>
      <button onclick="exportarPorColegio()">ðŸ“¥ Exportar menÃº para este colegio</button>
    </div>
  </div>

  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
  <script>
    let platos = [];
    let menuMensual = {};

    fetch('/api/platos')
      .then(res => res.json())
      .then(data => {
        platos = data.platos;
        const anioActual = new Date().getFullYear();
        document.getElementById('anio').value = anioActual;
        generarCalendario();
      });

    function clasificarPlatos() {
      const esPrimer = p => /lentejas|alubias|sopa|crema|pasta|guiso|purÃ©|verduras/i.test(p.nombre.toLowerCase());
      const esPostre = p => /fruta|yogur|flan|natilla|gelatina|queso fresco|manzana|pera|plÃ¡tano|naranja|uva|melÃ³n|sandÃ­a|fresa|kiwi|ciruela|higo|piÃ±a|mandarina/i.test(p.nombre.toLowerCase());
      const esAcompanamiento = p => /lechuga con|tomate con|pure de patata|patatas fritas|menestra|verduras asadas|patata cocida|patata al horno/i.test(p.nombre.toLowerCase());
      
      const primeros = platos.filter(esPrimer);
      const postres = platos.filter(esPostre);
      const acompanamientos = platos.filter(esAcompanamiento);
      const segundos = platos.filter(p => !esPrimer(p) && !esPostre(p) && !esAcompanamiento(p));
      
      return { primeros, segundos, acompanamientos, postres };
    }

    function generarCalendario() {
      const mes = parseInt(document.getElementById('mes').value);
      const anio = parseInt(document.getElementById('anio').value);
      const clave = `menu_${anio}_${mes}`;

      const guardado = localStorage.getItem(clave);
      if (guardado) {
        try {
          menuMensual = JSON.parse(guardado);
        } catch (e) {
          menuMensual = {};
        }
      } else {
        menuMensual = {};
      }

      const { primeros, segundos, acompanamientos, postres } = clasificarPlatos();
      let html = `<table><thead><tr>
        <th>DÃ­a</th>
        <th>1Âº Plato</th>
        <th>2Âº Plato</th>
        <th>AcompaÃ±amiento</th>
        <th>Postre</th>
      </tr></thead><tbody>`;

      const primerDia = new Date(anio, mes, 1);
      const ultimoDia = new Date(anio, mes + 1, 0);

      for (let d = primerDia.getDate(); d <= ultimoDia.getDate(); d++) {
        const fecha = new Date(anio, mes, d);
        const diaSemana = fecha.getDay();
        if (diaSemana >= 1 && diaSemana <= 5) {
          const fechaStr = fecha.toISOString().split('T')[0];
          const menuDia = menuMensual[fechaStr] || { primer: "", segundo: "", acompanamiento: "", postre: "" };

          html += `
            <tr>
              <td class="day-cell">${d} (${['', 'Lun', 'Mar', 'MiÃ©', 'Jue', 'Vie'][diaSemana]})</td>
              <td>
                <select onchange="actualizarMenu('${fechaStr}', 'primer', this.value)">
                  <option value="">-- Seleccionar --</option>
                  ${primeros.map(p => `<option value="${p.nombre}" ${p.nombre === menuDia.primer ? 'selected' : ''}>${p.nombre}</option>`).join('')}
                </select>
              </td>
              <td>
                <select onchange="actualizarMenu('${fechaStr}', 'segundo', this.value)">
                  <option value="">-- Seleccionar --</option>
                  ${segundos.map(p => `<option value="${p.nombre}" ${p.nombre === menuDia.segundo ? 'selected' : ''}>${p.nombre}</option>`).join('')}
                </select>
              </td>
              <td>
                <select onchange="actualizarMenu('${fechaStr}', 'acompanamiento', this.value)">
                  <option value="">-- Opcional --</option>
                  ${acompanamientos.map(p => `<option value="${p.nombre}" ${p.nombre === menuDia.acompanamiento ? 'selected' : ''}>${p.nombre}</option>`).join('')}
                </select>
              </td>
              <td>
                <select onchange="actualizarMenu('${fechaStr}', 'postre', this.value)">
                  <option value="">-- Seleccionar --</option>
                  ${postres.map(p => `<option value="${p.nombre}" ${p.nombre === menuDia.postre ? 'selected' : ''}>${p.nombre}</option>`).join('')}
                </select>
              </td>
            </tr>`;
        }
      }

      html += `</tbody></table>`;
      document.getElementById('calendario').innerHTML = html;
    }

    function actualizarMenu(fecha, tipo, valor) {
      if (!menuMensual[fecha]) menuMensual[fecha] = { primer: "", segundo: "", acompanamiento: "", postre: "" };
      menuMensual[fecha][tipo] = valor;
    }

    function guardarMenu() {
      const mes = document.getElementById('mes').value;
      const anio = document.getElementById('anio').value;
      const clave = `menu_${anio}_${mes}`;
      localStorage.setItem(clave, JSON.stringify(menuMensual));
      alert(`âœ… MenÃº de ${anio}-${String(parseInt(mes)+1).padStart(2,'0')} guardado.`);
    }

    function exportarPorColegio() {
      const colegio = document.getElementById('colegio').value;
      if (!colegio) {
        alert("Por favor, selecciona un colegio.");
        return;
      }

      const mes = document.getElementById('mes').value;
      const anio = document.getElementById('anio').value;
      const nombreMes = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"][mes];

      const { primeros, segundos, acompanamientos, postres } = clasificarPlatos();
      const todos = [...primeros, ...segundos, ...acompanamientos, ...postres];
      const getPlato = nombre => todos.find(p => p.nombre === nombre);

      const wb = XLSX.utils.book_new();
      const ws = {};

      // Crear hoja vacÃ­a
      const sheetData = [];
      for (let i = 0; i < 200; i++) {
        sheetData.push(new Array(50).fill(""));
      }
      const wsBase = XLSX.utils.aoa_to_sheet(sheetData);

      // Encabezado en fila 2
      XLSX.utils.sheet_add_aoa(wsBase, [[`MenÃº Escolar - ${colegio}`]], { origin: "I2" });
      XLSX.utils.sheet_add_aoa(wsBase, [[nombreMes]], { origin: "AB2" });
      XLSX.utils.sheet_add_aoa(wsBase, [[anio]], { origin: "AG2" });

      // Estilo para encabezado
      const encabezadoRango = XLSX.utils.decode_range("I2:AI2");
      for (let C = encabezadoRango.s.c; C <= encabezadoRango.e.c; ++C) {
        const cell = XLSX.utils.encode_cell({ r: 1, c: C });
        if (!wsBase[cell]) wsBase[cell] = { v: "", t: "s" };
        if (!wsBase[cell].s) wsBase[cell].s = {};
        wsBase[cell].s.font = { name: "Very Simple Chalk", sz: 22, color: { rgb: "385724" } };
        wsBase[cell].s.alignment = { horizontal: "center", vertical: "center" };
      }

      // Mapeo de dÃ­as a columnas
      const diasSemana = ['Lun', 'Mar', 'MiÃ©', 'Jue', 'Vie'];
      const colInicio = { 'Lun': 1, 'Mar': 8, 'MiÃ©': 15, 'Jue': 22, 'Vie': 29 }; // B=1, H=7â†’8, O=14â†’15, etc.

      let maxRow = 4; // empezamos en fila 5 (Ã­ndice 4)

      Object.keys(menuMensual).forEach(fecha => {
        const menu = menuMensual[fecha];
        if (!menu.primer && !menu.segundo && !menu.postre) return;

        const fechaObj = new Date(fecha);
        const diaSemIdx = fechaObj.getDay() - 1;
        if (diaSemIdx < 0 || diaSemIdx > 4) return;

        const diaSemana = diasSemana[diaSemIdx];
        const colBase = colInicio[diaSemana];

        // Obtener platos
        const p1 = getPlato(menu.primer);
        const p2 = getPlato(menu.segundo);
        const pA = getPlato(menu.acompanamiento);
        const p3 = getPlato(menu.postre);

        // Filas combinadas
        const ranges = [];
        const addCombined = (row, text) => {
          XLSX.utils.sheet_add_aoa(wsBase, [[text]], { origin: XLSX.utils.encode_cell({ r: row, c: colBase }) });
          const range = XLSX.utils.encode_range({ r: row, c: colBase }, { r: row, c: colBase + 5 });
          ranges.push(range);
          if (!wsBase[range]) wsBase[range] = {};
          wsBase[range].s = { font: { name: "Arial", sz: 16 }, alignment: { horizontal: "center", vertical: "center" } };
        };

        addCombined(4, p1?.nombre || "");
        addCombined(5, traducirAlIngles(p1?.nombre || ""));
        addCombined(6, p2?.nombre || "");
        addCombined(7, pA?.nombre || "");
        addCombined(8, `${traducirAlIngles(p2?.nombre || "")} with ${traducirAlIngles(pA?.nombre || "")}`);
        addCombined(9, `${p3?.nombre || ""} + Agua + Pan`);
        addCombined(10, `${traducirAlIngles(p3?.nombre || "")} + Water + Bread`);

        // NutriciÃ³n (filas 11-14)
        const nut1 = p1?.nutricion || {};
        const nut2 = p2?.nutricion || {};
        const nutA = pA?.nutricion || {};
        const nut3 = p3?.nutricion || {};

        const kcal_total = (nut1.kcal || 0) + (nut2.kcal || 0) + (nutA.kcal || 0) + (nut3.kcal || 0);
        const lip_total = (nut1.lip || 0) + (nut2.lip || 0) + (nutA.lip || 0) + (nut3.lip || 0);
        const ags_total = (nut1.ags || 0) + (nut2.ags || 0) + (nutA.ags || 0) + (nut3.ags || 0);
        const prot_total = (nut1.prot || 0) + (nut2.prot || 0) + (nutA.prot || 0) + (nut3.prot || 0);
        const hdec_total = (nut1.hdec || 0) + (nut2.hdec || 0) + (nutA.hdec || 0) + (nut3.hdec || 0);
        const azucares_total = (nut1.azucares || 0) + (nut2.azucares || 0) + (nutA.azucares || 0) + (nut3.azucares || 0);
        const vit_a_total = (nut1.vit_a || 0) + (nut2.vit_a || 0) + (nutA.vit_a || 0) + (nut3.vit_a || 0);
        const vit_c_total = (nut1.vit_c || 0) + (nut2.vit_c || 0) + (nutA.vit_c || 0) + (nut3.vit_c || 0);
        const vit_d_total = (nut1.vit_d || 0) + (nut2.vit_d || 0) + (nutA.vit_d || 0) + (nut3.vit_d || 0);
        const ca_total = (nut1.ca || 0) + (nut2.ca || 0) + (nutA.ca || 0) + (nut3.ca || 0);
        const fe_total = (nut1.fe || 0) + (nut2.fe || 0) + (nutA.fe || 0) + (nut3.fe || 0);
        const sal_total = (nut1.sal || 0) + (nut2.sal || 0) + (nutA.sal || 0) + (nut3.sal || 0);

        // Encabezados nutriciÃ³n
        const encNut = ["E (Kcal)", "LÃ­p (g)", "AGS (g)", "Prot (g)", "HdeC (g)", "Azucares"];
        XLSX.utils.sheet_add_aoa(wsBase, [encNut], { origin: XLSX.utils.encode_cell({ r: 11, c: colBase }) });
        // Valores nutriciÃ³n
        const valNut = [
          kcal_total.toFixed(1),
          lip_total.toFixed(1),
          ags_total.toFixed(1),
          prot_total.toFixed(1),
          hdec_total.toFixed(1),
          azucares_total.toFixed(1)
        ];
        XLSX.utils.sheet_add_aoa(wsBase, [valNut], { origin: XLSX.utils.encode_cell({ r: 12, c: colBase }) });
        // Encabezados micronutrientes
        const encMicro = ["Vit A (Âµg)", "Vit C (mg)", "vit D (Âµg)", "Ca (mg)", "Fe (mg)", "Sal"];
        XLSX.utils.sheet_add_aoa(wsBase, [encMicro], { origin: XLSX.utils.encode_cell({ r: 13, c: colBase }) });
        // Valores micronutrientes
        const valMicro = [
          vit_a_total.toFixed(1),
          vit_c_total.toFixed(1),
          vit_d_total.toFixed(1),
          ca_total.toFixed(1),
          fe_total.toFixed(1),
          sal_total.toFixed(1)
        ];
        XLSX.utils.sheet_add_aoa(wsBase, [valMicro], { origin: XLSX.utils.encode_cell({ r: 14, c: colBase }) });

        // Estilo Arial 11 para nutriciÃ³n
        for (let r = 11; r <= 14; r++) {
          for (let c = colBase; c <= colBase + 5; c++) {
            const cell = XLSX.utils.encode_cell({ r, c });
            if (!wsBase[cell]) wsBase[cell] = { v: "", t: "s" };
            if (!wsBase[cell].s) wsBase[cell].s = {};
            wsBase[cell].s.font = { name: "Arial", sz: 11 };
            wsBase[cell].s.alignment = { horizontal: "center", vertical: "center" };
          }
        }

        // Filas de cena (B16 y B17)
        XLSX.utils.sheet_add_aoa(wsBase, [["cena"]], { origin: XLSX.utils.encode_cell({ r: 15, c: colBase }) });
        const rangoCena1 = XLSX.utils.encode_range({ r: 15, c: colBase + 1 }, { r: 15, c: colBase + 5 });
        wsBase[rangoCena1] = { s: { fill: { fgColor: { rgb: "ffcc99" } } } };

        XLSX.utils.sheet_add_aoa(wsBase, [[""]], { origin: XLSX.utils.encode_cell({ r: 16, c: colBase }) });
        const rangoCena2 = XLSX.utils.encode_range({ r: 16, c: colBase + 1 }, { r: 16, c: colBase + 5 });
        wsBase[rangoCena2] = { s: { fill: { fgColor: { rgb: "ffcc99" } } } };

        // Columna A: dÃ­a del mes y dÃ­a de la semana
        XLSX.utils.sheet_add_aoa(wsBase, [[fechaObj.getDate()]], { origin: XLSX.utils.encode_cell({ r: 4, c: colBase - 1 }) });
        wsBase[XLSX.utils.encode_cell({ r: 4, c: colBase - 1 })].s = {
          font: { name: "Arial", sz: 12 },
          alignment: { horizontal: "center", vertical: "center" }
        };

        const rangoDiaSem = XLSX.utils.encode_range({ r: 5, c: colBase - 1 }, { r: 11, c: colBase - 1 });
        XLSX.utils.sheet_add_aoa(wsBase, [[diaSemana]], { origin: XLSX.utils.encode_cell({ r: 5, c: colBase - 1 }) });
        wsBase[rangoDiaSem] = {
          s: {
            font: { name: "Arial", sz: 12 },
            alignment: { horizontal: "center", vertical: "center", textRotation: 90 }
          }
        };

        maxRow = Math.max(maxRow, 16);
      });

      // Pie de pÃ¡gina
      const pieRow = maxRow + 2;
      XLSX.utils.sheet_add_aoa(wsBase, [["Valorado nutricionalmente por Leticia Montoiro Peinado, Diplomada en NutriciÃ³n Humana y DietÃ©tica. NÂº Colegiada CYL00207"]], { origin: XLSX.utils.encode_cell({ r: pieRow, c: 1 }) });
      XLSX.utils.sheet_add_aoa(wsBase, [["La fruta podrÃ¡ variar en funciÃ³n de su grado de madurez. ValoraciÃ³n nutricional en base a niÃ±os de 6-9 aÃ±os."]], { origin: XLSX.utils.encode_cell({ r: pieRow + 1, c: 1 }) });
      XLSX.utils.sheet_add_aoa(wsBase, [["Para cualquier consulta del menÃº o informaciÃ³n de alÃ©rgenos, puedes enviar un correo a nuestra nutricionista a: nutricion@cofuri.es"]], { origin: XLSX.utils.encode_cell({ r: pieRow + 2, c: 1 }) });
      XLSX.utils.sheet_add_aoa(wsBase, [["* Las recetas elaboradas llevan excluidos los alimentos arriba detallados."]], { origin: XLSX.utils.encode_cell({ r: pieRow + 3, c: 1 }) });

      // Ajustar anchos de columna
      wsBase["!cols"] = [];
      for (let i = 0; i < 50; i++) {
        wsBase["!cols"][i] = { wpx: 150 };
      }

      XLSX.utils.book_append_sheet(wb, wsBase, "MenÃº Mensual");

      const nombreColegio = colegio
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/\s+/g, "_")
        .replace(/[^\w]/g, "");

      const nombreArchivo = `menu_escolar_${nombreColegio}_${nombreMes}_${anio}.xlsx`;
      XLSX.writeFile(wb, nombreArchivo);
    }

    function traducirAlIngles(texto) {
      const traducciones = {
        "Lentejas": "Lentils", "Alubias": "Beans", "Sopa": "Soup", "Crema": "Cream", "Pasta": "Pasta",
        "Guiso": "Stew", "PurÃ©": "Mash", "Verduras": "Vegetables", "Pollo": "Chicken", "Pescado": "Fish",
        "Carne": "Meat", "JamÃ³n": "Ham", "Chorizo": "Chorizo", "Morcilla": "Blood sausage", "Merluza": "Hake",
        "Bacalao": "Cod", "SalmÃ³n": "Salmon", "AtÃºn": "Tuna", "Sardinas": "Sardines", "Patata": "Potato",
        "Zanahoria": "Carrot", "Cebolla": "Onion", "Tomate": "Tomato", "Pimiento": "Pepper", "CalabacÃ­n": "Zucchini",
        "Espinacas": "Spinach", "Acelgas": "Chard", "JudÃ­as verdes": "Green beans", "BrÃ³coli": "Broccoli",
        "Coliflor": "Cauliflower", "Lechuga": "Lettuce", "Puerro": "Leek", "Apio": "Celery", "Remolacha": "Beetroot",
        "ChampiÃ±Ã³n": "Mushroom", "Ajo": "Garlic", "Guisantes": "Peas", "MaÃ­z": "Corn", "Manzana": "Apple",
        "Pera": "Pear", "PlÃ¡tano": "Banana", "Naranja": "Orange", "Mandarina": "Tangerine", "Uva": "Grape",
        "MelÃ³n": "Melon", "SandÃ­a": "Watermelon", "Fresa": "Strawberry", "Kiwi": "Kiwi", "PiÃ±a": "Pineapple",
        "MelocotÃ³n": "Peach", "Ciruela": "Plum", "Higo": "Fig", "Aguacate": "Avocado", "Leche": "Milk",
        "Yogur": "Yogurt", "Queso fresco": "Fresh cheese", "RequesÃ³n": "Cottage cheese", "Huevo": "Egg",
        "Gelatina": "Gelatin", "Flan": "Flan", "Natillas": "Custard", "Pan": "Bread", "Agua": "Water",
        "Lechuga con tomate": "Lettuce with tomato", "Lechuga con zanahoria": "Lettuce with carrot",
        "Lechuga con remolacha": "Lettuce with beetroot", "Lechuga con aceituna": "Lettuce with olive",
        "Lechuga con maiz": "Lettuce with corn", "Tomate con maiz": "Tomato with corn",
        "Tomate con zanahoria": "Tomato with carrot", "Pure de patata": "Mashed potato",
        "Patatas fritas": "French fries", "Patata cocida": "Boiled potato", "Patata al horno": "Baked potato",
        "Menestra de verdura": "Mixed vegetables", "Verduras asadas": "Roasted vegetables"
      };

      let resultado = texto;
      for (const [es, en] of Object.entries(traducciones)) {
        const regex = new RegExp(`\\b${es}\\b`, 'gi');
        resultado = resultado.replace(regex, en);
      }
      return resultado;
    }
  </script>
</body>
</html>
